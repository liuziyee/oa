<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dorohedoro.mapper.UserMapper">

    <resultMap id="baseResultMap" type="user">
        <id column="id" jdbcType="BIGINT" property="id" />
        <result column="open_id" jdbcType="BIGINT" property="openId" />
        <result column="nickname" jdbcType="VARCHAR" property="nickname" />
        <result column="avatar_url" jdbcType="VARCHAR" property="avatarUrl" />
        <result column="name" jdbcType="VARCHAR" property="name" />
        <result column="sex" jdbcType="CHAR" property="sex" />
        <result column="tel" jdbcType="CHAR" property="tel" />
        <result column="roles" jdbcType="VARCHAR" property="roles" />
        <result column="dept_id" jdbcType="BIGINT" property="deptId" />
        <result column="dept_name" jdbcType="VARCHAR" property="deptName" />
        <result column="status" jdbcType="TINYINT" property="status" />
        <association property="today" javaType="checkinDTO">
            <result column="address" jdbcType="VARCHAR" property="address" />
            <result column="date" jdbcType="VARCHAR" property="date" />
            <result column="create_time" jdbcType="VARCHAR" property="createTime" />
            <result column="status" jdbcType="VARCHAR" property="status" />
            <result column="risk" jdbcType="VARCHAR" property="risk" />
        </association>
    </resultMap>
    
    <select id="isRootExist" resultType="boolean">
        select if(count(*), true, false) from user where root = 1;
    </select>
    <select id="selectPermissions" resultType="string">
        select permission_name
        from user
        join role on json_contains(user.roles, cast(role.id as char))
        join permission on json_contains(role.permissions, cast(permission.id as char))
        where user.id = #{userId} and user.status = 1;
    </select>
    
    <select id="selectByOpenId" resultType="long">
        select id from user where open_id = #{openId} and status = 1;
    </select>
    
    <select id="selectById" resultMap="baseResultMap">
        select user.id as id, open_id, nickname, avatar_url, name, sex, tel, roles, root, dept_id, address,
               ifnull(dept_name, '') as dept_name,
               cast(checkin.date as char) as date,
               date_format(checkin.create_time, '%H:%i') as create_time,
               if(checkin.status = 1, '正常', '迟到') as status,
               case
                   when checkin.risk = 1 then '低风险'
                   when checkin.risk = 2 then '中风险'
                   when checkin.risk = 3 then '高风险'
               end as risk
        from user
        left join dept on user.dept_id = dept.id
        left join checkin on user.id = checkin.user_id and checkin.date = current_date
        where user.id = #{userId} and user.status = 1;
    </select>
</mapper>
